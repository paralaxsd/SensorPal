<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:SensorPal.Mobile.Converters"
             xmlns:local="clr-namespace:SensorPal.Mobile.Pages"
             x:Class="SensorPal.Mobile.Pages.EventsPage"
             Title="Events">

    <ContentPage.Resources>
        <conv:LocalDateTimeConverter x:Key="LocalDateTime" Format="HH:mm:ss" />
        <conv:DurationConverter x:Key="Duration" />
    </ContentPage.Resources>

    <Grid Padding="16" RowSpacing="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Date picker -->
        <HorizontalStackLayout Grid.Row="0" Spacing="12" HorizontalOptions="Center" Margin="0,0,0,12">
            <Button Text="◀" WidthRequest="44" Clicked="OnPrevDayClicked" />
            <DatePicker x:Name="DateSelector"
                        Format="dd.MM.yyyy"
                        DateSelected="OnDateSelected"
                        VerticalOptions="Center" />
            <Button Text="▶" WidthRequest="44" Clicked="OnNextDayClicked" />
        </HorizontalStackLayout>

        <!-- Event list — fills remaining space, never resizes -->
        <CollectionView Grid.Row="1"
                        x:Name="EventsView"
                        SelectionMode="None"
                        EmptyView="No noise events for this day.">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="local:EventRowVm">
                    <Border Margin="0,4" Padding="12"
                            StrokeShape="RoundRectangle 8"
                            Stroke="LightGray"
                            BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}">
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" RowSpacing="4">
                            <Label Grid.Row="0" Grid.Column="0"
                                   Text="{Binding DetectedAt, Converter={StaticResource LocalDateTime}}"
                                   FontAttributes="Bold" FontSize="16" />
                            <Label Grid.Row="0" Grid.Column="1"
                                   Text="{Binding PeakDb, StringFormat='{0:F1} dBFS'}"
                                   TextColor="OrangeRed" VerticalOptions="Center" />
                            <Label Grid.Row="1" Grid.Column="0"
                                   Text="{Binding ClipDurationMs, Converter={StaticResource Duration}, StringFormat='Clip: {0}'}"
                                   TextColor="Gray" FontSize="13" />
                            <Button Grid.Row="1" Grid.Column="1"
                                    Text="{Binding ButtonText}"
                                    FontSize="13"
                                    IsVisible="{Binding HasClip}"
                                    IsEnabled="{Binding CanInteract}"
                                    Clicked="OnPlayClicked"
                                    CommandParameter="{Binding Id}" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Playback panel — overlays the list from the top, no layout shift -->
        <Border Grid.Row="1"
                x:Name="PlaybackPanel"
                IsVisible="False"
                VerticalOptions="Start"
                Margin="0,0,0,4"
                Padding="12,8"
                StrokeShape="RoundRectangle 8"
                Stroke="Transparent"
                BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3C}">
            <VerticalStackLayout Spacing="6">
                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                    <ActivityIndicator x:Name="DownloadSpinner"
                                       IsRunning="False"
                                       IsVisible="False"
                                       WidthRequest="18"
                                       HeightRequest="18"
                                       VerticalOptions="Center" />
                    <Label x:Name="PlaybackLabel"
                           Text=""
                           FontSize="13"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>
                <ProgressBar x:Name="PlaybackProgress"
                             IsVisible="False"
                             Progress="0" />
            </VerticalStackLayout>
        </Border>

    </Grid>

</ContentPage>
